#include "text.h"
#include <stdarg.h>
#include <stddef.h>
#include "nude.h"

#include <stdio.h>

typedef struct {
    char ch;
    uint8_t glyph[8];
} GlyphEntry;

float vscale = 2.1;

static const GlyphEntry pixel_font[] = {
    { ' ', { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 } },

    { '0', { 0x3C,0x7E,0xC7,0xC7,0xC7,0x7E,0x3C,0x00 } },
    { '1', { 0x18,0x38,0x78,0x18,0x18,0x18,0x7E,0x00 } },
    { '2', { 0x3C,0x7E,0xC7,0x1E,0x38,0x70,0xFF,0x00 } },
    { '3', { 0x3C,0x7E,0xC7,0x1E,0xC7,0x7E,0x3C,0x00 } },
    { '4', { 0x0E,0x1E,0x3E,0x6E,0xFE,0x0E,0x0E,0x00 } },
    { '5', { 0xFF,0xC0,0xFC,0x06,0xC7,0x7E,0x3C,0x00 } },
    { '6', { 0x3C,0x7E,0xC0,0xFC,0xC6,0x7E,0x3C,0x00 } },
    { '7', { 0xFF,0xC7,0x8E,0x1C,0x38,0x70,0x60,0x00 } },
    { '8', { 0x3C,0x7E,0xC7,0x3C,0xC7,0x7E,0x3C,0x00 } },
    { '9', { 0x3C,0x7E,0xC7,0x7E,0x07,0x7E,0x3C,0x00 } },

    { 'A', { 0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00 } },
    { 'B', { 0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00 } },
    { 'C', { 0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00 } },
    { 'D', { 0xF8,0x6C,0x66,0x66,0x66,0x6C,0xF8,0x00 } },
    { 'E', { 0xFE,0x62,0x68,0x78,0x68,0x62,0xFE,0x00 } },
    { 'F', { 0xFE,0x62,0x68,0x78,0x68,0x60,0xF0,0x00 } },
    { 'G', { 0x3C,0x66,0xC0,0xC0,0xCE,0x66,0x3E,0x00 } },
    { 'H', { 0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00 } },
    { 'I', { 0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00 } },
    { 'J', { 0x1E,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00 } },
    { 'K', { 0xE6,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00 } },
    { 'L', { 0xF0,0x60,0x60,0x60,0x62,0x66,0xFE,0x00 } },
    { 'M', { 0xC6,0xEE,0xFE,0xD6,0xC6,0xC6,0xC6,0x00 } },
    { 'N', { 0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x00 } },
    { 'O', { 0x3C,0x66,0xC3,0xC3,0xC3,0x66,0x3C,0x00 } },
    { 'P', { 0x7C,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00 } },
    { 'Q', { 0x3C,0x66,0xC3,0xC3,0xDB,0x6E,0x3D,0x00 } },
    { 'R', { 0x7C,0x66,0x66,0x7C,0x6C,0x66,0xE6,0x00 } },
    { 'S', { 0x3E,0x7E,0x60,0x3C,0x06,0x7E,0x3C,0x00 } },
    { 'T', { 0xFF,0xDB,0x18,0x18,0x18,0x18,0x3C,0x00 } },
    { 'U', { 0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00 } },
    { 'V', { 0xC3,0xC3,0x66,0x66,0x3C,0x3C,0x18,0x00 } },
    { 'W', { 0xC3,0xC3,0xD6,0xFE,0xEE,0xC6,0xC6,0x00 } },
    { 'X', { 0xC3,0x66,0x3C,0x18,0x3C,0x66,0xC3,0x00 } },
    { 'Y', { 0xC3,0x66,0x3C,0x18,0x18,0x18,0x3C,0x00 } },
    { 'Z', { 0xFF,0xC6,0x8C,0x18,0x32,0x66,0xFF,0x00 } },

    { 'a', { 0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00 } },
    { 'b', { 0xE0,0x60,0x7C,0x66,0x66,0x66,0xDC,0x00 } },
    { 'c', { 0x00,0x00,0x3C,0x66,0xC0,0x66,0x3C,0x00 } },
    { 'd', { 0x1C,0x0C,0x3C,0x6C,0x6C,0x6C,0x3E,0x00 } },
    { 'e', { 0x00,0x00,0x3C,0x66,0xFE,0x60,0x3C,0x00 } },
    { 'f', { 0x1C,0x36,0x30,0x78,0x30,0x30,0x78,0x00 } },
    { 'g', { 0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x7C } },
    { 'h', { 0xE0,0x60,0x6C,0x76,0x66,0x66,0xE6,0x00 } },
    { 'i', { 0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00 } },
    { 'j', { 0x06,0x00,0x0E,0x06,0x06,0x66,0x66,0x3C } },
    { 'k', { 0xE0,0x60,0x66,0x6C,0x78,0x6C,0xE6,0x00 } },
    { 'l', { 0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00 } },
    { 'm', { 0x00,0x00,0xEC,0xFE,0xD6,0xC6,0xC6,0x00 } },
    { 'n', { 0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x00 } },
    { 'o', { 0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00 } },
    { 'p', { 0x00,0x00,0xDC,0x66,0x66,0x7C,0x60,0xF0 } },
    { 'q', { 0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x0F } },
    { 'r', { 0x00,0x00,0xDC,0x76,0x60,0x60,0xF0,0x00 } },
    { 's', { 0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00 } },
    { 't', { 0x30,0x30,0xFC,0x30,0x30,0x36,0x1C,0x00 } },
    { 'u', { 0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00 } },
    { 'v', { 0x00,0x00,0xC6,0xC6,0x66,0x3C,0x18,0x00 } },
    { 'w', { 0x00,0x00,0xC6,0xD6,0xFE,0xEE,0xC6,0x00 } },
    { 'x', { 0x00,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x00 } },
    { 'y', { 0x00,0x00,0xC6,0xC6,0xC6,0x3E,0x06,0x7C } },
    { 'z', { 0x00,0x00,0xFE,0x8C,0x18,0x32,0xFE,0x00 } },

    { '.', { 0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00 } },
    { ',', { 0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30 } },
    { ':', { 0x00,0x00,0x00,0x18,0x00,0x18,0x00,0x00 } },
    { ';', { 0x00,0x00,0x00,0x18,0x00,0x18,0x18,0x30 } },
    { '!', { 0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00 } },
    { '?', { 0x3C,0x66,0x06,0x0C,0x18,0x00,0x18,0x00 } },
    { '-', { 0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00 } },
    { '_', { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF } },
    { '+', { 0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00 } },
    { '=', { 0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00 } },

    { '?', { 0x3C,0x66,0x06,0x0C,0x18,0x00,0x18,0x00 } },

    { '(', { 0x0E,0x18,0x30,0x30,0x30,0x18,0x0E,0x00 } },
    { ')', { 0x70,0x18,0x0C,0x0C,0x0C,0x18,0x70,0x00 } },

    { '[', { 0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00 } },
    { ']', { 0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00 } },

    { '{', { 0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00 } },
    { '}', { 0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00 } },

    { '/', { 0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00 } },
    { '\\', { 0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00 } },

    { '*', { 0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00 } },
    { '#', { 0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00 } },
    { '@', { 0x3C,0x66,0xCE,0xD6,0xD6,0xC0,0x7E,0x00 } },
    { '$', { 0x18,0x7E,0xC0,0x7C,0x06,0xFC,0x18,0x00 } },
    { '%', { 0xC2,0xC6,0x0C,0x18,0x30,0x66,0x46,0x00 } },
    { '&', { 0x38,0x6C,0x6C,0x38,0x6D,0xC6,0x7B,0x00 } },

    { '"', { 0x66,0x66,0x44,0x00,0x00,0x00,0x00,0x00 } },
    { '\'', { 0x18,0x18,0x10,0x00,0x00,0x00,0x00,0x00 } },

    { '<', { 0x0E,0x1C,0x38,0x70,0x38,0x1C,0x0E,0x00 } },
    { '>', { 0x70,0x38,0x1C,0x0E,0x1C,0x38,0x70,0x00 } },

    { '|', { 0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00 } },
    { '^', { 0x18,0x3C,0x66,0x00,0x00,0x00,0x00,0x00 } },
    { '~', { 0x00,0x00,0x32,0x4C,0x00,0x00,0x00,0x00 } },
};

static const size_t pixel_font_count = sizeof(pixel_font) / sizeof(pixel_font[0]);

static char TEXT_BUFFER[1024] = {0};

const char*
format_text(const char* format, ...) {
    va_list args;
    va_start(args, format);
    vsprintf(TEXT_BUFFER, format, args);
    va_end(args);
    return TEXT_BUFFER;
}

static const uint8_t*
get_glyph_for_char(char c) {
    size_t i;
    for (i = 0; i < pixel_font_count; ++i) {
        if (pixel_font[i].ch == c) return pixel_font[i].glyph;
    }
    for (i = 0; i < pixel_font_count; ++i)
        if (pixel_font[i].ch == '?') return pixel_font[i].glyph;
    return pixel_font[0].glyph;
}

void
n_glyph_draw(uint32_t* buffer,
             int x0, int y0,
             const uint8_t glyph[8],
             uint32_t color, int scale) {
    int col, row;
    for (col = 0; col < 8; ++col) {
        uint8_t colbits = glyph[col];
        for (row = 0; row < 8; ++row) {
            int bit = (colbits >> row) & 1;
            if (bit) {
                n_point_draw(buffer, x0 + 8 - row * scale + scale * 0.5, y0 + col * scale * 0.5 * vscale, color);
            }
        }
    }
}

void
n_text_draw(uint32_t* buffer,
            int x, int y,
            const char* text,
            uint32_t color,
            int scale,
            int spacing) {
    int cursor_x = x;
    const char* p;
    for (p = text; *p; ++p) {
        const uint8_t* g = get_glyph_for_char(*p);
        n_glyph_draw(buffer, cursor_x, y, g, color, scale);
        cursor_x += 8 * scale + spacing;
    }
}

void
n_text_format_draw(uint32_t* buffer,
                   int x, int y,
                   uint32_t color,
                   int scale,
                   int spacing,
                   const char* format, ...) {
    va_list args;
    va_start(args, format);
    vsprintf(TEXT_BUFFER, format, args);
    va_end(args);
    int tx, ty;
    n_text_size(TEXT_BUFFER, 2, 2, &tx, &ty);
    n_text_draw(buffer, tx / 2 + x, ty / 2 + y, TEXT_BUFFER, color, scale, spacing);
}

void
n_text_size(const char* text,
            int scale,
            int spacing,
            int* w, int* h) {
    int cursor_x = 0;
    int cursor_y = 8 * scale * 0.5 * vscale;
    const char* p;
    for (p = text; *p; ++p) {
        /* const uint8_t* g = */ get_glyph_for_char(*p);
        cursor_x += 8 * scale + spacing;
    }
    *w = cursor_x;
    *h = cursor_y;
}
